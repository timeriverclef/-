<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é’é“¶æ¡¥ Â· ä»£é™…äº¤æµè®ºå›</title>
<meta name="description" content="è¿æ¥é’å¹´ä¸é•¿è¾ˆçš„åŒå‘äº¤æµç¤¾åŒºï¼Œé™ªä¼´ã€æŒ‡å¯¼ä¸å…±åŒæˆé•¿ã€‚">
<style>
  :root{
    --bg: #fafafa;
    --card: #ffffff;
    --fg: #1f2328;
    --muted:#6b7280;
    --line:#e5e7eb;
    --brand:#2563eb;
    --brand-weak:#dbeafe;
    --good:#16a34a;
    --warn:#b45309;
    --danger:#b91c1c;
    --senior:#7c3aed; /* é•¿è¾ˆå¾½ç« è‰² */
    --youth:#059669;  /* é’å¹´å¾½ç« è‰² */
    --radius:14px;
    --shadow:0 2px 10px rgba(0,0,0,.06);
    --font: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", "PingFang SC", "Microsoft YaHei", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    --fs-base:16px;
    --fs-lg:18px;
  }
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--fg);font-family:var(--font);
    font-size:var(--fs-base);line-height:1.6;
  }
  /* é«˜å¯¹æ¯”åº¦ */
  body.high-contrast{
    --bg:#ffffff; --card:#ffffff; --fg:#000; --muted:#111; --line:#000;
    --brand:#000; --brand-weak:#fff; --shadow:none;
  }
  /* å¤§å­—æ¨¡å¼ */
  body.large-text{ font-size: var(--fs-lg); }
  /* ç®€æ´æ¨¡å¼ */
  body.simple-mode .decor{ display:none; }
  body.simple-mode .aside{ display:none; }
  .skip-link{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
  .skip-link:focus{left:8px;top:8px;width:auto;height:auto;background:#000;color:#fff;padding:6px 10px;z-index:10000;border-radius:8px}

  header{
    position:sticky;top:0;background:rgba(255,255,255,.8);backdrop-filter:saturate(180%) blur(10px);
    border-bottom:1px solid var(--line);z-index:100;
  }
  .topbar{
    max-width:1200px;margin:0 auto;display:flex;gap:12px;align-items:center;padding:10px 16px;
  }
  .logo{display:flex;align-items:center;gap:10px;font-weight:700}
  .logo .dot{width:12px;height:12px;border-radius:50%;background:var(--brand)}
  .logo span{font-size:18px;letter-spacing:.5px}
  .search{
    flex:1;display:flex;align-items:center;background:var(--card);border:1px solid var(--line);
    padding:6px 10px;border-radius:999px;box-shadow:var(--shadow);
  }
  .search input{border:none;outline:none;background:transparent;width:100%;font-size:14px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .toggle{display:inline-flex;align-items:center;gap:6px;background:var(--card);border:1px solid var(--line);
    padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer;box-shadow:var(--shadow)}
  .toggle input{accent-color:var(--brand)}

  nav.tabs{
    max-width:1200px;margin:0 auto;display:flex;gap:8px;align-items:center;padding:8px 16px 12px 16px;overflow-x:auto;
  }
  .tab{
    padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:var(--card);
    cursor:pointer;white-space:nowrap;font-size:14px;user-select:none;
  }
  .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
  main{
    max-width:1200px;margin:14px auto;display:grid;grid-template-columns:280px 1fr;gap:16px;align-items:start;
    padding:0 16px;
  }
  @media (max-width: 920px){ main{grid-template-columns:1fr} }
  .aside{position:sticky;top:86px}
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
  }
  .card .title{font-weight:700}
  .aside .card{padding:14px}
  .aside .group{display:flex;flex-direction:column;gap:10px}
  .pill{
    display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;
  }
  .pill[data-variant="brand"]{background:var(--brand-weak);border-color:#bfdbfe}
  .pill input{accent-color:var(--brand)}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;padding:10px 14px;border-radius:10px;
    cursor:pointer;font-weight:600;background:var(--brand);color:#fff;
  }
  .btn.secondary{background:#111;color:#fff}
  .btn.ghost{background:transparent;color:var(--fg);border:1px solid var(--line)}
  .btn.small{padding:6px 10px;border-radius:8px;font-weight:600}
  .btn:focus-visible{outline:3px solid #60a5fa;outline-offset:2px}

  /* Feed */
  #feed{ display:flex; flex-direction:column; gap:12px; }
  article.post{
    display:grid;grid-template-columns:56px 1fr;gap:12px;padding:14px;
  }
  .avatar{
    width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#e0e7ff,#f5d0fe);display:flex;align-items:center;justify-content:center;font-weight:800;
    color:#111;border:1px solid var(--line)
  }
  .post-head{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .name{font-weight:700}
  .role-badge{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:#fff}
  .role-badge[data-role="senior"]{border-color:#ede9fe;background:#f5f3ff;color:var(--senior)}
  .role-badge[data-role="youth"]{border-color:#d1fae5;background:#ecfdf5;color:var(--youth)}
  .need-badge{font-size:11px;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;border:1px solid #e0e7ff}
  .meta{font-size:12px;color:var(--muted)}
  .tags{display:flex;flex-wrap:wrap;gap:6px}
  .tag{font-size:11px;padding:3px 8px;border-radius:999px;border:1px dashed #cbd5e1;color:#334155;background:#f8fafc}
  .post-title{font-size:16px;font-weight:800;margin:6px 0}
  .post-body{color:#111}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .stat{font-size:12px;color:var(--muted)}

  /* Dialog / Modal */
  dialog{
    border:none;border-radius:16px;max-width:720px;width:calc(100% - 32px);padding:0;box-shadow:0 20px 60px rgba(0,0,0,.25);
  }
  dialog::backdrop{background:rgba(0,0,0,.3)}
  .modal{padding:18px}
  .modal h3{margin:0 0 12px 0}
  .form{display:grid;gap:12px}
  .row{display:grid;gap:8px}
  .row.h{grid-template-columns:1fr 1fr;gap:12px}
  label{font-size:14px;font-weight:700}
  input[type="text"], input[type="search"], textarea, select{
    padding:10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:14px
  }
  textarea{min-height:120px;resize:vertical}
  .modal .footer{display:flex;justify-content:flex-end;gap:8px;margin-top:6px}
  .hint{font-size:12px;color:var(--muted)}

  /* Reduce animation if user prefers */
  @media (prefers-reduced-motion: reduce){
    *{scroll-behavior:auto !important;animation:none !important;transition:none !important}
  }

  /* Footer */
  footer{padding:32px 16px;color:var(--muted);text-align:center}
  .link{color:var(--brand);text-decoration:none;border-bottom:1px dashed var(--brand)}
</style>
</head>
<body>
<a href="#main" class="skip-link">è·³åˆ°ä¸»è¦å†…å®¹</a>

<header aria-label="ç«™ç‚¹å¤´éƒ¨">
  <div class="topbar">
    <div class="logo" aria-label="é’é“¶æ¡¥">
      <span class="dot" aria-hidden="true"></span><span>é’é“¶æ¡¥</span>
      <span class="decor" aria-hidden="true" style="font-weight:400;color:var(--muted)">ï½œè¿æ¥é’å¹´ä¸é•¿è¾ˆ</span>
    </div>
    <div class="search" role="search">
      <svg width="18" height="18" aria-hidden="true" viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5L21.5 20L15.5 14m-6 0C7 14 5 12 5 9.5S7 5 9.5 5S14 7 14 9.5S12 14 9.5 14Z"/></svg>
      <input id="searchInput" type="search" placeholder="æœç´¢è¯é¢˜ / æ ‡ç­¾ / åŸå¸‚â€¦" aria-label="æœç´¢è®ºå›å†…å®¹" />
    </div>
    <div class="toolbar" role="group" aria-label="æ— éšœç¢ä¸æ˜¾ç¤ºè®¾ç½®">
      <label class="toggle" title="å¤§å­—æ¨¡å¼">
        <input id="toggleLarge" type="checkbox" />å¤§å­—
      </label>
      <label class="toggle" title="é«˜å¯¹æ¯”åº¦">
        <input id="toggleContrast" type="checkbox" />é«˜å¯¹æ¯”
      </label>
      <label class="toggle" title="ç®€æ´æ¨¡å¼ï¼ˆéšè—ä¾§æ è£…é¥°ï¼‰">
        <input id="toggleSimple" type="checkbox" />ç®€æ´
      </label>
      <button class="btn small" id="btnCompose" aria-haspopup="dialog">ï¼‹ å‘å¸–</button>
    </div>
  </div>

  <nav class="tabs" aria-label="æ¿å—å¯¼èˆª" id="tabs"></nav>
</header>

<main id="main">
  <!-- ä¾§æ  -->
  <aside class="aside" aria-label="å¿«é€Ÿç­›é€‰ä¸å‘å¸–">
    <div class="card group" role="region" aria-label="å¿«é€Ÿå‘å¸ƒ">
      <div class="title">å¿«é€Ÿå‘å¸ƒ</div>
      <div class="hint">é€‰æ‹©ä½ çš„æ„å›¾ï¼Œæˆ‘ä»¬ä¼šä¸ºä½ é€‰æ‹©åˆé€‚æ¿å—ä¸æ¨¡æ¿ã€‚</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn ghost" data-fast="ask">æˆ‘æƒ³<span style="font-weight:800">æ±‚æŒ‡å¯¼</span></button>
        <button class="btn ghost" data-fast="offer">æˆ‘èƒ½<span style="font-weight:800">æä¾›æŒ‡å¯¼/é™ªä¼´</span></button>
      </div>
      <hr style="border:none;border-top:1px solid var(--line)" />
      <div class="title">å¸¸ç”¨ç­›é€‰</div>
      <label class="pill"><input id="onlySenior" type="checkbox" />åªçœ‹é•¿è¾ˆ</label>
      <label class="pill"><input id="onlyYouth" type="checkbox" />åªçœ‹é’å¹´</label>
      <label class="pill"><input id="onlyComp" type="checkbox" />åªçœ‹é™ªä¼´</label>
      <label class="pill"><input id="onlyGuide" type="checkbox" />åªçœ‹æŒ‡å¯¼</label>

      <div class="title" style="margin-top:8px">å…´è¶£æ ‡ç­¾</div>
      <div id="interestFilters" style="display:flex;flex-wrap:wrap;gap:8px"></div>
    </div>

    <div class="card group" role="region" aria-label="ç¤¾åŒºæç¤º" style="margin-top:12px">
      <div class="title">å®‰å…¨ä¸å‹å¥½</div>
      <ul style="margin:8px 0 0 18px;padding:0">
        <li>ç§ä¸‹è½¬è´¦éœ€è°¨æ…ï¼Œçº¿ä¸‹è§é¢è¯·ç»“ä¼´å¹¶å‘ŠçŸ¥å®¶äººï¼›</li>
        <li>å°Šé‡å½¼æ­¤ç§°å‘¼ä¸ä½œæ¯ï¼›</li>
        <li>æ¬¢è¿ä½¿ç”¨â€œä¸¾æŠ¥â€ä¸â€œæ„Ÿè°¢â€ã€‚</li>
      </ul>
    </div>
  </aside>

  <!-- ä¿¡æ¯æµ -->
  <section id="feed" aria-live="polite" aria-busy="false"></section>
</main>

<footer>
  <div>Â© é’é“¶æ¡¥ â€¢ ä¸€èµ·æŠŠç”Ÿæ´»è¿‡å¾—æ›´æœ‰æ¸©åº¦ã€‚ Â· <a class="link" href="#" onclick="alert('ç¤¾åŒºè§„èŒƒï¼ˆæ ·ä¾‹ï¼‰ï¼šäº’ç›¸å°Šé‡ã€ä¿æŠ¤éšç§ã€è°¨æ…çº¿ä¸‹ã€åå¯¹å¹´é¾„æ­§è§†ã€‚');return false;">ç¤¾åŒºè§„èŒƒ</a></div>
</footer>

<!-- å‘å¸–å¼¹çª— -->
<dialog id="composeDialog" aria-label="å‘å¸ƒå†…å®¹">
  <form method="dialog" class="modal" id="composeForm">
    <h3>å‘å¸ƒå†…å®¹</h3>
    <div class="form">
      <div class="row h">
        <div class="row">
          <label for="role">ä½ çš„èº«ä»½</label>
          <select id="role" required>
            <option value="youth">é’å¹´</option>
            <option value="senior">é•¿è¾ˆ</option>
          </select>
        </div>
        <div class="row">
          <label for="intent">äº¤æµæ„å›¾</label>
          <select id="intent" required>
            <option value="ask_guidance">æ±‚æŒ‡å¯¼</option>
            <option value="offer_guidance">æä¾›æŒ‡å¯¼</option>
            <option value="seek_companionship">æ±‚é™ªä¼´</option>
            <option value="offer_companionship">æä¾›é™ªä¼´</option>
          </select>
        </div>
      </div>

      <div class="row h">
        <div class="row">
          <label for="category">å‘å¸ƒåˆ°</label>
          <select id="category" required>
            <option>é™ªä¼´å¹¿åœº</option>
            <option>é’å¹´é—®ç­”</option>
            <option>é•¿è¾ˆè®²å ‚</option>
            <option>æŠ€èƒ½äº’åŠ©</option>
            <option>æ•…äº‹é¦†</option>
            <option>æ´»åŠ¨</option>
            <option>èµ„æºåº“</option>
            <option>ç«™åŠ¡</option>
          </select>
        </div>
        <div class="row">
          <label for="city">åŸå¸‚ï¼ˆé€‰å¡«ï¼‰</label>
          <input id="city" type="text" placeholder="å¦‚ï¼šæˆéƒ½ / ä¸Šæµ·" />
        </div>
      </div>

      <div class="row">
        <label for="title">æ ‡é¢˜</label>
        <input id="title" type="text" required placeholder="ä¸€å¥è¯è¯´æ¸…ä½ çš„ä¸»é¢˜" />
      </div>

      <div class="row">
        <label for="content">æ­£æ–‡</label>
        <textarea id="content" required placeholder="å…·ä½“æƒ³èŠ/èƒ½å¸®çš„æ˜¯ä»€ä¹ˆï¼Ÿå¸Œæœ›ä»€ä¹ˆæ—¶å€™äº¤æµï¼Ÿæ˜¯å¦å¯è¯­éŸ³/è§†é¢‘ï¼Ÿ"></textarea>
      </div>

      <div class="row h">
        <div class="row">
          <label for="tags">æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
          <input id="tags" type="text" placeholder="å¦‚ï¼šæ•°ç , å¥åº·, ç¼–ç¨‹" />
        </div>
        <div class="row">
          <label for="voice">è¯­éŸ³å…¥å£</label>
          <select id="voice">
            <option value="no">ä¸éœ€è¦</option>
            <option value="yes">å¯è¯­éŸ³/è¯­éŸ³å¸–</option>
          </select>
          <div class="hint">åŸå‹å ä½ï¼šåç»­å¯æ¥å…¥å½•éŸ³/æ’­æŠ¥ã€‚</div>
        </div>
      </div>
    </div>
    <div class="footer">
      <button class="btn ghost" value="cancel">å–æ¶ˆ</button>
      <button class="btn" id="submitPost" value="submit">å‘å¸ƒ</button>
    </div>
  </form>
</dialog>

<!-- ä¸¾æŠ¥å¼¹çª— -->
<dialog id="reportDialog" aria-label="ä¸¾æŠ¥">
  <form method="dialog" class="modal" id="reportForm">
    <h3>ä¸¾æŠ¥å†…å®¹</h3>
    <div class="form">
      <div class="row">
        <label for="reason">åŸå› </label>
        <select id="reason" required>
          <option>å¹¿å‘Š/æ°´è´´</option>
          <option>è¾±éª‚/æ­§è§†</option>
          <option>è¯ˆéª—/æ”¶è´¹è¯±å¯¼</option>
          <option>å…¶å®ƒ</option>
        </select>
      </div>
      <div class="row">
        <label for="reasonDetail">è¡¥å……ï¼ˆé€‰å¡«ï¼‰</label>
        <textarea id="reasonDetail" placeholder="ç®€è¦è¯´æ˜æƒ…å†µ"></textarea>
      </div>
    </div>
    <div class="footer">
      <button class="btn ghost" value="cancel">å–æ¶ˆ</button>
      <button class="btn" value="submit">æäº¤</button>
    </div>
  </form>
</dialog>

<script>
/** ---------- åŸºç¡€æ•°æ®ä¸çŠ¶æ€ ---------- **/
const categories = ["å…¨éƒ¨","é™ªä¼´å¹¿åœº","é’å¹´é—®ç­”","é•¿è¾ˆè®²å ‚","æŠ€èƒ½äº’åŠ©","æ•…äº‹é¦†","æ´»åŠ¨","èµ„æºåº“","ç«™åŠ¡"];
const interestsPool = ["æ•°ç ","çƒ¹é¥ª","æ‘„å½±","ä¼ ç»Ÿæ‰‹è‰º","ç¼–ç¨‹","ç†è´¢","è¿åŠ¨","å¥åº·","æ±‚èŒ","æ—…è¡Œ","ä¹¦æ³•","å›­è‰º"];
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

const state = {
  category: "å…¨éƒ¨",
  query: "",
  onlySenior: false,
  onlyYouth: false,
  onlyComp: false,
  onlyGuide: false,
  interestFilter: new Set(),
  sort: "æœ€æ–°",
  thanked: new Set(JSON.parse(localStorage.getItem('thanked')||'[]')),
  starred: new Set(JSON.parse(localStorage.getItem('starred')||'[]')),
};

const samplePosts = [
  {id:"p1", name:"ç‹é˜¿å§¨", role:"senior", age:62, city:"ä¸Šæµ·", interests:["å¥åº·","çƒ¹é¥ª"], category:"é™ªä¼´å¹¿åœº",
   need:"offer_companionship", title:"æ™šä¸Š7-8ç‚¹ï¼Œçº¿ä¸Šæ•£æ­¥èŠå¤©ä¹ˆï¼Ÿ", body:"é€€ä¼‘åæ—¶é—´å¤šï¼Œå–œæ¬¢å¬å¹´è½»äººåˆ†äº«å·¥ä½œè¶£äº‹ï¼Œä¹Ÿèƒ½èŠå…»èŠ±åšèœã€‚", tags:["é™ªä¼´","å›­è‰º"], thanks:12, stars:4, time:"2025-10-28T19:00:00", voice:false},
  {id:"p2", name:"ææƒ³", role:"youth", age:24, city:"æˆéƒ½", interests:["ç¼–ç¨‹","æ±‚èŒ"], category:"é’å¹´é—®ç­”",
   need:"ask_guidance", title:"ç¬¬ä¸€æ¬¡å…¥èŒä¸é•¿è¾ˆåŒäº‹æ²Ÿé€šï¼Œæœ‰ä»€ä¹ˆå¿Œè®³/å»ºè®®ï¼Ÿ", body:"åˆšæ¯•ä¸šè¿›äº†å›½ä¼ï¼Œæƒ³è¯·æ•™å¦‚ä½•è¯´è¯æ›´å¾—ä½“ã€æ€ä¹ˆè¯·æ•™ä¸å†’çŠ¯ã€‚", tags:["èŒåœº","æ²Ÿé€š"], thanks:21, stars:8, time:"2025-10-31T09:30:00", voice:false},
  {id:"p3", name:"èµµå”", role:"senior", age:67, city:"åŒ—äº¬", interests:["ç†è´¢","è¿åŠ¨"], category:"é•¿è¾ˆè®²å ‚",
   need:"offer_guidance", title:"æˆ¿è´·æå‰è¿˜è¿˜æ˜¯æŠ•èµ„ï¼Ÿç»™å­©å­/å­™è¾ˆçš„ç†è´¢æ¡†æ¶", body:"åšäº†30å¹´é“¶è¡Œï¼Œç»™å‡ºé£é™©åˆ†çº§ä¸å®¶åº­èµ„äº§é…ç½®çš„ç®€å•æ¨¡æ¿ã€‚", tags:["ç†è´¢","å®¶åº­"], thanks:45, stars:15, time:"2025-10-25T13:00:00", voice:true},
  {id:"p4", name:"Annie", role:"youth", age:28, city:"æ·±åœ³", interests:["æ•°ç ","æ‘„å½±"], category:"æŠ€èƒ½äº’åŠ©",
   need:"ask_guidance", title:"ç»™å¥¶å¥¶æ¢æ™ºèƒ½æœºï¼Œå¦‚ä½•è®¾ç½®æ›´é€‚è€ï¼Ÿ", body:"éœ€è¦æ‰‹æŠŠæ‰‹æ¸…å•ï¼šå­—ä½“ã€å›¾æ ‡ã€å¸¸ç”¨è”ç³»äººã€è¯ˆéª—æ‹¦æˆªã€è§†é¢‘é€šè¯ä¸€é”®ã€‚", tags:["æ•°ç ","é€‚è€åŒ–"], thanks:9, stars:3, time:"2025-10-29T10:10:00", voice:false},
  {id:"p5", name:"é™ˆçˆ·çˆ·", role:"senior", age:72, city:"å—äº¬", interests:["ä¼ ç»Ÿæ‰‹è‰º","ä¹¦æ³•"], category:"æ•…äº‹é¦†",
   need:"offer_guidance", title:"å°æ—¶å€™çš„ç«¹ç¼–ä¸å¦‚ä»Šçš„æ‰‹ä½œï¼šä¸€å¼ å›¾æ•™ä½ ä¸Šæ‰‹", body:"åˆ†äº«å‡ ç§å¸¸è§ç¼–æ³•ä»¥åŠå¦‚ä½•åœ¨å®¶å®‰å…¨å¤„ç†ç«¹ç¯¾ã€‚", tags:["æ‰‹ä½œ","éé—"], thanks:33, stars:20, time:"2025-09-18T08:30:00", voice:true},
  {id:"p6", name:"Liu", role:"youth", age:26, city:"æ­å·", interests:["è¿åŠ¨","æ—…è¡Œ"], category:"æ´»åŠ¨",
   need:"seek_companionship", title:"å‘¨æœ«è¥¿æ¹–æ…¢èµ°å›¢ï¼ˆé•¿è¾ˆä¼˜å…ˆï¼‰", body:"å‘¨å…­ä¸Šåˆ9ç‚¹ï¼Œ3å…¬é‡Œæ…¢èµ°ï¼Œäº’ç›¸ä»‹ç»å…´è¶£çˆ±å¥½ã€‚", tags:["çº¿ä¸‹","æ­å·"], thanks:6, stars:7, time:"2025-10-30T09:00:00", voice:false},
  {id:"p7", name:"å­™å§¨", role:"senior", age:60, city:"é’å²›", interests:["å¥åº·","å›­è‰º"], category:"é’å¹´é—®ç­”",
   need:"offer_guidance", title:"å¹´è½»äººæŠ¤å—“ä¸é¢ˆæ¤ï¼šå£°å¸¦ä¸åå§¿å°è´´å£«", body:"é•¿æœŸåŠå…¬å®¤å·¥ä½œè¦æ³¨æ„è¿™äº›åŠ¨ä½œä¸é¢‘ç‡ã€‚", tags:["å¥åº·","é¢ˆæ¤"], thanks:14, stars:5, time:"2025-10-22T15:22:00", voice:false},
  {id:"p8", name:"å°å”", role:"youth", age:21, city:"è¥¿å®‰", interests:["å­¦ä¹ ","ç¼–ç¨‹"], category:"é’å¹´é—®ç­”",
   need:"ask_guidance", title:"å¦‚ä½•ç¤¼è²Œæ‹’ç»äº²æˆšçš„èŒä¸šå»ºè®®ï¼Ÿ", body:"è¿‡å¹´å¿«åˆ°äº†ï¼Œæ±‚å‡ å¥ä¸ä¼¤äººåˆæœ‰æ•ˆçš„è¡¨è¾¾ã€‚", tags:["å®¶åº­","æ²Ÿé€š"], thanks:18, stars:4, time:"2025-10-27T19:40:00", voice:false},
  {id:"p9", name:"å¼ è€å¸ˆ", role:"senior", age:66, city:"å¹¿å·", interests:["æ•™è‚²","é˜…è¯»"], category:"é•¿è¾ˆè®²å ‚",
   need:"offer_guidance", title:"ç»™åˆšå·¥ä½œçš„ä½ ï¼šå†™é‚®ä»¶çš„ä¸‰ä¸ªå±‚æ¬¡", body:"ç»“æ„åŒ–è¡¨è¾¾ã€è¯»è€…æ„è¯†ã€â€œä¸€å±è¯»å®Œâ€çš„æŠ€å·§ã€‚", tags:["èŒåœº","å†™ä½œ"], thanks:52, stars:29, time:"2025-10-19T11:15:00", voice:false},
  {id:"p10", name:"Cora", role:"youth", age:29, city:"ä¸Šæµ·", interests:["ç†è´¢","æ‘„å½±"], category:"æŠ€èƒ½äº’åŠ©",
   need:"offer_companionship", title:"åˆä¼‘ 12:30-13:00 é™ªå¤–å©†è§†é¢‘åƒé¥­", body:"æ„¿æ„é™ªèŠï¼Œä¹Ÿå¯ä»¥å¸®è®¾ç½®å¸¸ç”¨è”ç³»äººå¿«é€Ÿæ‹¨å·ã€‚", tags:["é™ªä¼´","è§†é¢‘"], thanks:11, stars:3, time:"2025-10-28T12:30:00", voice:false},
  {id:"p11", name:"åˆ˜é˜¿å§¨", role:"senior", age:64, city:"å¦é—¨", interests:["çƒ¹é¥ª","æ—…è¡Œ"], category:"æ•…äº‹é¦†",
   need:"offer_guidance", title:"é—½å—å‘³ï¼šæ‰‹æŠŠæ‰‹æ•™æµ·è›ç…", body:"ä»é€‰æ–™åˆ°ç«å€™ï¼Œå®¶å¸¸ä¸å®´å®¢çš„å·®åˆ«ã€‚", tags:["çƒ¹é¥ª","å®¶å¸¸èœ"], thanks:40, stars:12, time:"2025-10-01T10:00:00", voice:true},
  {id:"p12", name:"Neo", role:"youth", age:23, city:"é•¿æ²™", interests:["æ±‚èŒ","æ•°ç "], category:"é’å¹´é—®ç­”",
   need:"ask_guidance", title:"ç¬¬ä¸€ä»½å·¥ä½œè¯¥ä¸è¯¥ç¦»å¼€å®¶ä¹¡åŸå¸‚ï¼Ÿ", body:"æœºä¼š vs. å®¶äººé™ªä¼´ï¼Œæƒ³å¬é•¿è¾ˆç»éªŒã€‚", tags:["é€‰æ‹©","èŒåœº"], thanks:17, stars:5, time:"2025-10-20T20:05:00", voice:false},
];

let posts = [...samplePosts];

/** ---------- åˆå§‹åŒ– UI ---------- **/
const tabs = $("#tabs");
const feed = $("#feed");
const composeDialog = $("#composeDialog");
const reportDialog = $("#reportDialog");

function mountTabs(){
  tabs.innerHTML = "";
  categories.forEach(c=>{
    const el = document.createElement("button");
    el.className = "tab" + (c===state.category?" active":"");
    el.textContent = c;
    el.setAttribute("role","tab");
    el.setAttribute("aria-selected", c===state.category ? "true":"false");
    el.dataset.category = c;
    tabs.appendChild(el);
  });
}
mountTabs();

/** å…´è¶£ç­›é€‰ */
function mountInterestFilters(){
  const host = $("#interestFilters");
  host.innerHTML = "";
  interestsPool.forEach(t=>{
    const label = document.createElement("label");
    label.className = "pill";
    label.innerHTML = `<input type="checkbox" data-tag="${t}">${t}`;
    host.appendChild(label);
  });
}
mountInterestFilters();

/** ---------- æ¸²æŸ“å¸–å­ ---------- **/
const needMap = {
  ask_guidance: "æ±‚æŒ‡å¯¼",
  offer_guidance: "æä¾›æŒ‡å¯¼",
  seek_companionship: "æ±‚é™ªä¼´",
  offer_companionship: "æä¾›é™ªä¼´",
};

function fmtTime(iso){
  const d = new Date(iso);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
}
function initials(name){
  return name.replace(/[^\u4e00-\u9fa5a-zA-Z]/g,'').slice(0,2).toUpperCase() || "å‹";
}

function render(){
  feed.setAttribute("aria-busy","true");
  let list = posts.slice();

  // åˆ†ç±»
  if(state.category!=="å…¨éƒ¨"){
    list = list.filter(p=>p.category===state.category);
  }
  // æœç´¢
  const q = state.query.trim().toLowerCase();
  if(q){
    list = list.filter(p => (
      p.title.toLowerCase().includes(q) ||
      p.body.toLowerCase().includes(q) ||
      p.tags.join(",").toLowerCase().includes(q) ||
      (p.city||"").toLowerCase().includes(q)
    ));
  }
  // èº«ä»½ç­›é€‰
  if(state.onlySenior && !state.onlyYouth){
    list = list.filter(p=>p.role==="senior");
  }else if(state.onlyYouth && !state.onlySenior){
    list = list.filter(p=>p.role==="youth");
  }
  // æ„å›¾ç­›é€‰
  if(state.onlyComp && !state.onlyGuide){
    list = list.filter(p=>p.need.includes("companionship"));
  }else if(state.onlyGuide && !state.onlyComp){
    list = list.filter(p=>p.need.includes("guidance"));
  }
  // å…´è¶£æ ‡ç­¾
  if(state.interestFilter.size){
    list = list.filter(p => p.tags.some(t=>state.interestFilter.has(t)) || p.interests.some(t=>state.interestFilter.has(t)));
  }
  // æ’åº
  list.sort((a,b)=>{
    if(state.sort==="æ„Ÿè°¢æœ€å¤š") return b.thanks - a.thanks;
    return new Date(b.time) - new Date(a.time);
  });

  // æ¸²æŸ“
  feed.innerHTML = "";
  if(!list.length){
    const empty = document.createElement("div");
    empty.className = "card";
    empty.style.padding = "24px";
    empty.innerHTML = `<div style="font-weight:700">è¿™é‡Œæš‚æ—¶æ²¡æœ‰å†…å®¹</div><div class="hint">è¯•è¯•æ›´æ¢ç­›é€‰æ¡ä»¶ï¼Œæˆ–è€… <button class="btn small" id="emptyCompose">å»å‘ä¸€å¸–</button></div>`;
    feed.appendChild(empty);
    $("#emptyCompose")?.addEventListener("click",()=>openCompose());
  }

  list.forEach(p=>{
    const art = document.createElement("article");
    art.className = "post card";
    art.dataset.id = p.id;
    art.innerHTML = `
      <div class="avatar" aria-hidden="true">${initials(p.name)}</div>
      <div>
        <div class="post-head">
          <span class="name">${p.name}</span>
          <span class="role-badge" data-role="${p.role}">${p.role==="senior"?"é•¿è¾ˆ":"é’å¹´"}</span>
          <span class="need-badge">${needMap[p.need] || "äº¤æµ"}</span>
          ${p.voice ? `<span class="pill" title="è¯­éŸ³å¯ç”¨">ğŸ¤ è¯­éŸ³</span>`:""}
          <span class="meta">Â· ${p.city||"çº¿ä¸Š"} Â· ${fmtTime(p.time)}</span>
        </div>
        <div class="post-title">${p.title}</div>
        <div class="post-body">${p.body}</div>
        <div class="tags" style="margin-top:6px">
          ${p.tags.map(t=>`<span class="tag" role="note">#${t}</span>`).join("")}
        </div>
        <div class="actions">
          <button class="btn small" data-act="thank" aria-label="è¡¨ç¤ºæ„Ÿè°¢">æ„Ÿè°¢ <span class="stat" data-k="thanks">(${p.thanks})</span></button>
          <button class="btn small ghost" data-act="star" aria-label="æ”¶è—">æ”¶è— <span class="stat" data-k="stars">(${p.stars})</span></button>
          <button class="btn small ghost" data-act="reply">ç•™è¨€</button>
          <button class="btn small ghost" data-act="dm">ç§ä¿¡</button>
          <button class="btn small ghost" data-act="report">ä¸¾æŠ¥</button>
          ${p.category==="æ´»åŠ¨" ? `<button class="btn small" data-act="join">æŠ¥åæ´»åŠ¨</button>`:""}
        </div>
      </div>
    `;
    // å·²æ„Ÿè°¢/å·²æ”¶è—çŠ¶æ€
    if(state.thanked.has(p.id)){
      art.querySelector('[data-act="thank"]').disabled = true;
      art.querySelector('[data-act="thank"]').title = "å·²æ„Ÿè°¢";
    }
    if(state.starred.has(p.id)){
      art.querySelector('[data-act="star"]').classList.remove('ghost');
    }
    feed.appendChild(art);
  });

  feed.setAttribute("aria-busy","false");
}
render();

/** ---------- äº‹ä»¶ç»‘å®š ---------- **/
tabs.addEventListener("click",(e)=>{
  const btn = e.target.closest(".tab");
  if(!btn) return;
  state.category = btn.dataset.category;
  mountTabs(); render();
  tabs.scrollIntoView({behavior:"smooth",block:"nearest"});
});

$("#searchInput").addEventListener("input",(e)=>{ state.query = e.target.value; render(); });

$("#onlySenior").addEventListener("change",e=>{ state.onlySenior = e.target.checked; render(); });
$("#onlyYouth").addEventListener("change",e=>{ state.onlyYouth = e.target.checked; render(); });
$("#onlyComp").addEventListener("change",e=>{ state.onlyComp = e.target.checked; render(); });
$("#onlyGuide").addEventListener("change",e=>{ state.onlyGuide = e.target.checked; render(); });

$("#interestFilters").addEventListener("change",(e)=>{
  const cb = e.target;
  if(cb && cb.dataset.tag){
    if(cb.checked) state.interestFilter.add(cb.dataset.tag);
    else state.interestFilter.delete(cb.dataset.tag);
    render();
  }
});

/** ä¿¡æ¯æµè¡Œä¸ºï¼ˆæ„Ÿè°¢ã€æ”¶è—ã€ç•™è¨€ã€ç§ä¿¡ã€ä¸¾æŠ¥ã€æŠ¥åï¼‰ */
feed.addEventListener("click",(e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  const card = e.target.closest("article.post");
  const id = card?.dataset.id;
  const p = posts.find(x=>x.id===id);
  if(!p) return;

  const act = btn.dataset.act;
  if(act==="thank"){
    if(state.thanked.has(id)) return;
    p.thanks += 1; state.thanked.add(id); btn.disabled = true;
    localStorage.setItem('thanked', JSON.stringify(Array.from(state.thanked)));
    card.querySelector('[data-k="thanks"]').textContent = `(${p.thanks})`;
  }
  if(act==="star"){
    if(state.starred.has(id)){ state.starred.delete(id); p.stars = Math.max(0, p.stars-1); btn.classList.add("ghost"); }
    else { state.starred.add(id); p.stars += 1; btn.classList.remove("ghost"); }
    localStorage.setItem('starred', JSON.stringify(Array.from(state.starred)));
    card.querySelector('[data-k="stars"]').textContent = `(${p.stars})`;
  }
  if(act==="reply"){
    alert("ç•™è¨€ç¤ºä¾‹ï¼šåç«¯æ¥å…¥åå¯å¼¹å‡ºè¯„è®ºæ¡†å¹¶@å¯¹æ–¹ã€‚");
  }
  if(act==="dm"){
    alert("ç§ä¿¡ç¤ºä¾‹ï¼šåˆæœŸå»ºè®®ä»…å…è®¸ç›¸äº’å…³æ³¨åç§ä¿¡ï¼Œé™ä½éªšæ‰°é£é™©ã€‚");
  }
  if(act==="report"){
    reportDialog.showModal();
    reportDialog.returnValue = "";
    reportDialog.addEventListener("close", function onClose(){
      reportDialog.removeEventListener("close", onClose);
      if(reportDialog.returnValue!=="cancel" && $("#reason").value){
        alert("å·²æ”¶åˆ°ä¸¾æŠ¥ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ã€‚æ„Ÿè°¢å®ˆæŠ¤ç¤¾åŒºã€‚");
      }
    });
  }
  if(act==="join"){
    alert("æŠ¥åæˆåŠŸï¼ˆç¤ºä¾‹ï¼‰ã€‚å®é™…åº”å¼¹å‡ºæŠ¥åè¡¨ä¸å®‰å…¨é¡»çŸ¥ç¡®è®¤ã€‚");
  }
});

/** å‘å¸–æµç¨‹ */
function openCompose(pref){
  // é¢„è®¾ï¼šå¿«é€Ÿå…¥å£å¯è®¾ç½®æ„å›¾ä¸æ¿å—
  if(pref){
    $("#intent").value = pref.intent;
    $("#category").value = pref.category;
    $("#role").value = pref.role;
  }
  composeDialog.showModal();
}
$("#btnCompose").addEventListener("click",()=>openCompose());
$$('[data-fast]').forEach(b=>{
  b.addEventListener("click",()=>{
    const t = b.dataset.fast;
    if(t==="ask"){ openCompose({intent:"ask_guidance", category:"é’å¹´é—®ç­”", role:"youth"}); }
    else { openCompose({intent:"offer_guidance", category:"é•¿è¾ˆè®²å ‚", role:"senior"}); }
  });
});
$("#composeForm").addEventListener("submit",(e)=>{
  if(e.submitter?.value==="cancel"){ return; }
  e.preventDefault();
  const p = {
    id: "p"+(Date.now()),
    name: $("#role").value==="senior" ? "çƒ­å¿ƒé•¿è¾ˆ" : "çƒ­å¿ƒé’å¹´",
    role: $("#role").value,
    age: $("#role").value==="senior" ? 60 : 25,
    city: $("#city").value.trim(),
    interests: [],
    category: $("#category").value,
    need: $("#intent").value,
    title: $("#title").value.trim(),
    body: $("#content").value.trim(),
    tags: $("#tags").value.split(",").map(s=>s.trim()).filter(Boolean),
    thanks: 0, stars: 0,
    time: new Date().toISOString(),
    voice: $("#voice").value==="yes"
  };
  if(!p.title || !p.body){ alert("è¯·å¡«å†™æ ‡é¢˜ä¸æ­£æ–‡"); return; }
  posts.unshift(p);
  composeDialog.close();
  state.category = "å…¨éƒ¨"; mountTabs(); render();
  window.scrollTo({top:0, behavior:"smooth"});
});

/** å¤–è§‚å¼€å…³ï¼ˆå¤§å­—/é«˜å¯¹æ¯”/ç®€æ´ï¼‰ï¼ŒæŒä¹…åŒ–åˆ° localStorage */
function initAppearance(){
  const set = (key, cls, el) => {
    const saved = localStorage.getItem(key)==="1";
    if(saved){ document.body.classList.add(cls); el.checked = true; }
    el.addEventListener("change",()=>{
      document.body.classList.toggle(cls, el.checked);
      localStorage.setItem(key, el.checked ? "1":"0");
    });
  };
  set("pref_large","large-text", $("#toggleLarge"));
  set("pref_contrast","high-contrast", $("#toggleContrast"));
  set("pref_simple","simple-mode", $("#toggleSimple"));
}
initAppearance();
</script>
</body>
</html>
